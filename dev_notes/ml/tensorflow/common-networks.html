<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Common Networks | Joe Lin</title>
    <meta name="description" content="">
    
    
    <link rel="preload" href="/assets/css/0.styles.c36325bf.css" as="style"><link rel="preload" href="/assets/js/app.e04e06c7.js" as="script"><link rel="preload" href="/assets/js/8.42ea1d9b.js" as="script"><link rel="prefetch" href="/assets/js/vendors~docsearch.e47c214c.js"><link rel="prefetch" href="/assets/js/2.ca61bc24.js"><link rel="prefetch" href="/assets/js/3.7c27b296.js"><link rel="prefetch" href="/assets/js/4.61a94b53.js"><link rel="prefetch" href="/assets/js/5.9fd63af5.js"><link rel="prefetch" href="/assets/js/6.57f14f08.js"><link rel="prefetch" href="/assets/js/7.0f4a11df.js"><link rel="prefetch" href="/assets/js/9.91201f3b.js"><link rel="prefetch" href="/assets/js/10.d18985b9.js"><link rel="prefetch" href="/assets/js/11.3950009d.js"><link rel="prefetch" href="/assets/js/12.44aeca04.js"><link rel="prefetch" href="/assets/js/13.6e946f62.js"><link rel="prefetch" href="/assets/js/14.a435ff09.js"><link rel="prefetch" href="/assets/js/15.da8d70ff.js"><link rel="prefetch" href="/assets/js/16.77bf496d.js">
    <link rel="stylesheet" href="/assets/css/0.styles.c36325bf.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div><a href="/" class="home-link router-link-active"><!----><span class="site-name">
      Joe Lin
    </span></a><div class="links"><form id="search-form" class="algolia-search-wrapper search-box"><input id="algolia-search-input" class="search-query"></form><nav class="nav-links can-hide"><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">DevNotes</span><span class="arrow right"></span></a><ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----><a href="/dev_notes/chatbot/" class="nav-link">Chatbot</a></li><li class="dropdown-item"><!----><a href="/dev_notes/ml/" class="nav-link router-link-active">Machine Learning</a></li></ul></div></div><!----></nav></div></header><div class="sidebar-mask"></div><div class="sidebar"><nav class="nav-links"><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">DevNotes</span><span class="arrow right"></span></a><ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----><a href="/dev_notes/chatbot/" class="nav-link">Chatbot</a></li><li class="dropdown-item"><!----><a href="/dev_notes/ml/" class="nav-link router-link-active">Machine Learning</a></li></ul></div></div><!----></nav><ul class="sidebar-links"><li><div class="sidebar-group first collapsable"><p class="sidebar-heading open"><span>Tensorflow</span><span class="arrow down"></span></p><ul class="sidebar-group-items"><li><a href="/dev_notes/ml/tensorflow/common-networks.html" class="active sidebar-link">Common Networks</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/dev_notes/ml/tensorflow/common-networks.html#cnn-mnist" class="sidebar-link">CNN (MNIST)</a></li><li class="sidebar-sub-header"><a href="/dev_notes/ml/tensorflow/common-networks.html#rnn-classification-mnist" class="sidebar-link">RNN Classification (MNIST)</a></li><li class="sidebar-sub-header"><a href="/dev_notes/ml/tensorflow/common-networks.html#rnn-regression-seq-to-seq" class="sidebar-link">RNN Regression (Seq-to-Seq)</a></li><li class="sidebar-sub-header"><a href="/dev_notes/ml/tensorflow/common-networks.html#autoencoder-mnist" class="sidebar-link">AutoEncoder (MNIST)</a></li></ul></li><li><a href="/dev_notes/ml/tensorflow/syntax.html" class="sidebar-link">Tensorflow Syntax</a></li></ul></div></li><li><div class="sidebar-group collapsable"><p class="sidebar-heading"><span>Tools</span><span class="arrow right"></span></p><!----></div></li></ul></div><div class="page"><div class="content"><h1>Common Networks</h1><h2 id="cnn-mnist"><a href="#cnn-mnist" aria-hidden="true" class="header-anchor">#</a> CNN (MNIST)</h2><blockquote><p>Setup</p></blockquote><div class="language-python line-numbers-mode"><pre class="language-python"><code><span class="token keyword">from</span> tensorflow<span class="token punctuation">.</span>examples<span class="token punctuation">.</span>tutorials<span class="token punctuation">.</span>mnist <span class="token keyword">import</span> input_data
<span class="token keyword">import</span> tensorflow <span class="token keyword">as</span> tf
<span class="token keyword">import</span> numpy <span class="token keyword">as</span> np
<span class="token keyword">import</span> matplotlib<span class="token punctuation">.</span>pyplot <span class="token keyword">as</span> plt

tf<span class="token punctuation">.</span>set_random_seed<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
np<span class="token punctuation">.</span>random<span class="token punctuation">.</span>seed<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><blockquote><p>Prepare Input</p></blockquote><div class="language-python line-numbers-mode"><pre class="language-python"><code>BATCH_SIZE <span class="token operator">=</span> <span class="token number">50</span>
LR <span class="token operator">=</span> <span class="token number">0.001</span>  <span class="token comment"># learning rate</span>

mnist <span class="token operator">=</span> input_data<span class="token punctuation">.</span>read_data_sets<span class="token punctuation">(</span><span class="token string">'./mnist'</span><span class="token punctuation">,</span> one_hot<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
test_x <span class="token operator">=</span> mnist<span class="token punctuation">.</span>test<span class="token punctuation">.</span>images<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token number">2000</span><span class="token punctuation">]</span> <span class="token comment"># use only 2000 images for testing</span>
test_y <span class="token operator">=</span> mnist<span class="token punctuation">.</span>test<span class="token punctuation">.</span>labels<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token number">2000</span><span class="token punctuation">]</span>

tf_x <span class="token operator">=</span> tf<span class="token punctuation">.</span>placeholder<span class="token punctuation">(</span>tf<span class="token punctuation">.</span>float32<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token boolean">None</span><span class="token punctuation">,</span> <span class="token number">28</span><span class="token operator">*</span><span class="token number">28</span><span class="token punctuation">]</span><span class="token punctuation">)</span> 
tf_y <span class="token operator">=</span> tf<span class="token punctuation">.</span>placeholder<span class="token punctuation">(</span>tf<span class="token punctuation">.</span>int32<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token boolean">None</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
tf_x <span class="token operator">/=</span> <span class="token number">255</span><span class="token punctuation">.</span> <span class="token comment"># normalize image pixels (pixels' max value is 255)</span>

<span class="token comment"># (batch, height, width, channel)</span>
images <span class="token operator">=</span> tf<span class="token punctuation">.</span>reshape<span class="token punctuation">(</span>tf_x<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">28</span><span class="token punctuation">,</span> <span class="token number">28</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><blockquote><p>CNN</p></blockquote><div class="language-python line-numbers-mode"><pre class="language-python"><code>conv1 <span class="token operator">=</span> tf<span class="token punctuation">.</span>layers<span class="token punctuation">.</span>conv2d<span class="token punctuation">(</span>   <span class="token comment"># shape (28, 28, 1)</span>
    inputs<span class="token operator">=</span>images<span class="token punctuation">,</span>
    filters<span class="token operator">=</span><span class="token number">16</span><span class="token punctuation">,</span>
    kernel_size<span class="token operator">=</span><span class="token number">5</span><span class="token punctuation">,</span>
    strides<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span>
    padding<span class="token operator">=</span><span class="token string">'same'</span><span class="token punctuation">,</span>
    activation<span class="token operator">=</span>tf<span class="token punctuation">.</span>nn<span class="token punctuation">.</span>relu
<span class="token punctuation">)</span> <span class="token comment"># -&gt; (28, 28, 16)</span>
pool1 <span class="token operator">=</span> tf<span class="token punctuation">.</span>layers<span class="token punctuation">.</span>max_pooling2d<span class="token punctuation">(</span>
    conv1<span class="token punctuation">,</span>
    pool_size<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">,</span>
    strides<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">,</span>
<span class="token punctuation">)</span> <span class="token comment"># -&gt; (14, 14, 16)</span>
conv2 <span class="token operator">=</span> tf<span class="token punctuation">.</span>layers<span class="token punctuation">.</span>conv2d<span class="token punctuation">(</span>pool1<span class="token punctuation">,</span> <span class="token number">32</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">'same'</span><span class="token punctuation">,</span>
                         activation<span class="token operator">=</span>tf<span class="token punctuation">.</span>nn<span class="token punctuation">.</span>relu<span class="token punctuation">)</span> <span class="token comment"># -&gt; (14, 14, 32)</span>
pool2 <span class="token operator">=</span> tf<span class="token punctuation">.</span>layers<span class="token punctuation">.</span>max_pooling2d<span class="token punctuation">(</span>conv2<span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span>    <span class="token comment"># -&gt; (7, 7, 32)</span>
flat <span class="token operator">=</span> tf<span class="token punctuation">.</span>reshape<span class="token punctuation">(</span>pool2<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token operator">*</span><span class="token number">7</span><span class="token operator">*</span><span class="token number">32</span><span class="token punctuation">]</span><span class="token punctuation">)</span>          <span class="token comment"># -&gt; (7*7*32, )</span>
output <span class="token operator">=</span> tf<span class="token punctuation">.</span>layers<span class="token punctuation">.</span>dense<span class="token punctuation">(</span>flat<span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span>              <span class="token comment"># output layer</span>
</code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br></div></div><blockquote><p>Loss / Training Ops</p></blockquote><div class="language- line-numbers-mode"><pre class="language-text"><code>loss = tf.losses.softmax_cross_entropy(onehot_labels=tf_y, logits=output)
train_op = tf.train.AdamOptimizer(LR).minimize(loss)
accuracy = tf.metrics.accuracy(labels=tf.argmax(tf_y, axis=1), 
                               predictions=tf.argmax(output, axis=1))[1]
</code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><blockquote><p>Training</p></blockquote><div class="language-python line-numbers-mode"><pre class="language-python"><code>sess <span class="token operator">=</span> tf<span class="token punctuation">.</span>Session<span class="token punctuation">(</span><span class="token punctuation">)</span>
init_op <span class="token operator">=</span> tf<span class="token punctuation">.</span>group<span class="token punctuation">(</span>tf<span class="token punctuation">.</span>global_variables_initializer<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> 
                   tf<span class="token punctuation">.</span>local_variables_initializer<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
sess<span class="token punctuation">.</span>run<span class="token punctuation">(</span>init_op<span class="token punctuation">)</span>

<span class="token keyword">for</span> step <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">600</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    b_x<span class="token punctuation">,</span> b_y <span class="token operator">=</span> mnist<span class="token punctuation">.</span>train<span class="token punctuation">.</span>next_batch<span class="token punctuation">(</span>BATCH_SIZE<span class="token punctuation">)</span>
    _<span class="token punctuation">,</span> loss_ <span class="token operator">=</span> sess<span class="token punctuation">.</span>run<span class="token punctuation">(</span><span class="token punctuation">[</span>train_op<span class="token punctuation">,</span> loss<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>tf_x<span class="token punctuation">:</span> b_x<span class="token punctuation">,</span> tf_y<span class="token punctuation">:</span> b_y<span class="token punctuation">}</span><span class="token punctuation">)</span>

    <span class="token keyword">if</span> step <span class="token operator">%</span> <span class="token number">50</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">:</span>
        accuracy_ <span class="token operator">=</span> sess<span class="token punctuation">.</span>run<span class="token punctuation">(</span>accuracy<span class="token punctuation">,</span> <span class="token punctuation">{</span>tf_x<span class="token punctuation">:</span> test_x<span class="token punctuation">,</span> tf_y<span class="token punctuation">:</span> test_y<span class="token punctuation">}</span><span class="token punctuation">)</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'Step:'</span><span class="token punctuation">,</span> step<span class="token punctuation">,</span> <span class="token string">'| train loss: %.4f'</span> <span class="token operator">%</span>
              loss_<span class="token punctuation">,</span> <span class="token string">'| test accuracy: %.2f'</span> <span class="token operator">%</span> accuracy_<span class="token punctuation">)</span>
</code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><blockquote><p>Testing</p></blockquote><div class="language-python line-numbers-mode"><pre class="language-python"><code><span class="token comment"># print 10 predictions from test data</span>
test_output <span class="token operator">=</span> sess<span class="token punctuation">.</span>run<span class="token punctuation">(</span>output<span class="token punctuation">,</span> <span class="token punctuation">{</span>tf_x<span class="token punctuation">:</span> test_x<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token number">10</span><span class="token punctuation">]</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
pred_y <span class="token operator">=</span> np<span class="token punctuation">.</span>argmax<span class="token punctuation">(</span>test_output<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>pred_y<span class="token punctuation">,</span> <span class="token string">'prediction number'</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>np<span class="token punctuation">.</span>argmax<span class="token punctuation">(</span>test_y<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token number">10</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">'real number'</span><span class="token punctuation">)</span> <span class="token comment"># test_y is one-hot encoded</span>
</code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><h2 id="rnn-classification-mnist"><a href="#rnn-classification-mnist" aria-hidden="true" class="header-anchor">#</a> RNN Classification (MNIST)</h2><blockquote><p>Setup (skip, same as CNN)</p></blockquote><blockquote><p>Prepare Input</p></blockquote><div class="language-python line-numbers-mode"><pre class="language-python"><code><span class="token comment"># Hyper Parameters</span>
BATCH_SIZE <span class="token operator">=</span> <span class="token number">64</span>
TIME_STEP <span class="token operator">=</span> <span class="token number">28</span>          <span class="token comment"># rnn time step / image height</span>
INPUT_SIZE <span class="token operator">=</span> <span class="token number">28</span>         <span class="token comment"># rnn input size / image width</span>
LR <span class="token operator">=</span> <span class="token number">0.01</span>               <span class="token comment"># learning rate</span>

mnist <span class="token operator">=</span> input_data<span class="token punctuation">.</span>read_data_sets<span class="token punctuation">(</span><span class="token string">'./mnist'</span><span class="token punctuation">,</span> one_hot<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
test_x <span class="token operator">=</span> mnist<span class="token punctuation">.</span>test<span class="token punctuation">.</span>images<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token number">2000</span><span class="token punctuation">]</span>
test_y <span class="token operator">=</span> mnist<span class="token punctuation">.</span>test<span class="token punctuation">.</span>labels<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token number">2000</span><span class="token punctuation">]</span>

<span class="token comment"># shape(batch, 784)</span>
tf_x <span class="token operator">=</span> tf<span class="token punctuation">.</span>placeholder<span class="token punctuation">(</span>tf<span class="token punctuation">.</span>float32<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token boolean">None</span><span class="token punctuation">,</span> TIME_STEP <span class="token operator">*</span> INPUT_SIZE<span class="token punctuation">]</span><span class="token punctuation">)</span>
tf_y <span class="token operator">=</span> tf<span class="token punctuation">.</span>placeholder<span class="token punctuation">(</span>tf<span class="token punctuation">.</span>int32<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token boolean">None</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">]</span><span class="token punctuation">)</span>

<span class="token comment"># (batch, height, width, channel)</span>
image <span class="token operator">=</span> tf<span class="token punctuation">.</span>reshape<span class="token punctuation">(</span>tf_x<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> TIME_STEP<span class="token punctuation">,</span> INPUT_SIZE<span class="token punctuation">]</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br></div></div><blockquote><p>RNN</p></blockquote><div class="language-python line-numbers-mode"><pre class="language-python"><code>rnn_cell <span class="token operator">=</span> tf<span class="token punctuation">.</span>nn<span class="token punctuation">.</span>rnn_cell<span class="token punctuation">.</span>LSTMCell<span class="token punctuation">(</span>num_units<span class="token operator">=</span><span class="token number">64</span><span class="token punctuation">)</span>
outputs<span class="token punctuation">,</span> <span class="token punctuation">(</span>h_c<span class="token punctuation">,</span> h_n<span class="token punctuation">)</span> <span class="token operator">=</span> tf<span class="token punctuation">.</span>nn<span class="token punctuation">.</span>dynamic_rnn<span class="token punctuation">(</span>
    rnn_cell<span class="token punctuation">,</span>                   <span class="token comment"># cell you have chosen</span>
    image<span class="token punctuation">,</span>                      <span class="token comment"># input</span>
    initial_state<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span>         <span class="token comment"># the initial hidden state</span>
    dtype<span class="token operator">=</span>tf<span class="token punctuation">.</span>float32<span class="token punctuation">,</span>           <span class="token comment"># must given if set initial_state = None</span>
    <span class="token comment"># False: (batch, time step, input); True: (time step, batch, input)</span>
    time_major<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">,</span>
<span class="token punctuation">)</span>
<span class="token comment"># output based on the last output step</span>
output <span class="token operator">=</span> tf<span class="token punctuation">.</span>layers<span class="token punctuation">.</span>dense<span class="token punctuation">(</span>outputs<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><blockquote><p>Loss / Training Ops (skip, same as CNN)</p></blockquote><blockquote><p>Training (skip, same as CNN)</p></blockquote><blockquote><p>Testing (skip, same as CNN)</p></blockquote><hr><p><strong>[SideNote]</strong> Multi-layer RNN Cell</p><div class="language-python line-numbers-mode"><pre class="language-python"><code><span class="token comment"># create 2 LSTMCells</span>
rnn_layers <span class="token operator">=</span> <span class="token punctuation">[</span>
    tf<span class="token punctuation">.</span>nn<span class="token punctuation">.</span>rnn_cell<span class="token punctuation">.</span>LSTMCell<span class="token punctuation">(</span><span class="token number">128</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    tf<span class="token punctuation">.</span>nn<span class="token punctuation">.</span>rnn_cell<span class="token punctuation">.</span>LSTMCell<span class="token punctuation">(</span><span class="token number">256</span><span class="token punctuation">)</span>
<span class="token punctuation">]</span>

<span class="token comment"># create a RNN cell composed sequentially of a number of RNNCells</span>
multi_rnn_cell <span class="token operator">=</span> tf<span class="token punctuation">.</span>nn<span class="token punctuation">.</span>rnn_cell<span class="token punctuation">.</span>MultiRNNCell<span class="token punctuation">(</span>rnn_layers<span class="token punctuation">)</span>

<span class="token comment"># 'outputs' is a tensor of shape [batch_size, max_time, 256]</span>
<span class="token comment"># 'state' is a N-tuple where N is the number of LSTMCells containing a</span>
<span class="token comment"># tf.contrib.rnn.LSTMStateTuple for each cell</span>
outputs<span class="token punctuation">,</span> state <span class="token operator">=</span> tf<span class="token punctuation">.</span>nn<span class="token punctuation">.</span>dynamic_rnn<span class="token punctuation">(</span>cell<span class="token operator">=</span>multi_rnn_cell<span class="token punctuation">,</span>
                                   inputs<span class="token operator">=</span>data<span class="token punctuation">,</span>
                                   dtype<span class="token operator">=</span>tf<span class="token punctuation">.</span>float32<span class="token punctuation">)</span>
</code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div><h2 id="rnn-regression-seq-to-seq"><a href="#rnn-regression-seq-to-seq" aria-hidden="true" class="header-anchor">#</a> RNN Regression (Seq-to-Seq)</h2><blockquote><p>Setup</p></blockquote><div class="language-python line-numbers-mode"><pre class="language-python"><code><span class="token keyword">import</span> tensorflow <span class="token keyword">as</span> tf
<span class="token keyword">import</span> numpy <span class="token keyword">as</span> np
<span class="token keyword">import</span> matplotlib<span class="token punctuation">.</span>pyplot <span class="token keyword">as</span> plt
</code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><blockquote><p>Prepare Input</p></blockquote><div class="language-python line-numbers-mode"><pre class="language-python"><code>TIME_STEP <span class="token operator">=</span> <span class="token number">10</span>       <span class="token comment"># rnn time step</span>
INPUT_SIZE <span class="token operator">=</span> <span class="token number">1</span>      <span class="token comment"># rnn input size</span>
CELL_SIZE <span class="token operator">=</span> <span class="token number">32</span>      <span class="token comment"># rnn cell size</span>
LR <span class="token operator">=</span> <span class="token number">0.02</span>           <span class="token comment"># learning rate</span>

<span class="token comment"># Generate sin wave as input and cos wave as target</span>
steps <span class="token operator">=</span> np<span class="token punctuation">.</span>linspace<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> np<span class="token punctuation">.</span>pi<span class="token operator">*</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">,</span> dtype<span class="token operator">=</span>np<span class="token punctuation">.</span>float32<span class="token punctuation">)</span>
x_np <span class="token operator">=</span> np<span class="token punctuation">.</span>sin<span class="token punctuation">(</span>steps<span class="token punctuation">)</span>
y_np <span class="token operator">=</span> np<span class="token punctuation">.</span>cos<span class="token punctuation">(</span>steps<span class="token punctuation">)</span>

tf_x <span class="token operator">=</span> tf<span class="token punctuation">.</span>placeholder<span class="token punctuation">(</span>tf<span class="token punctuation">.</span>float32<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token boolean">None</span><span class="token punctuation">,</span> TIME_STEP<span class="token punctuation">,</span> INPUT_SIZE<span class="token punctuation">]</span><span class="token punctuation">)</span>
tf_y <span class="token operator">=</span> tf<span class="token punctuation">.</span>placeholder<span class="token punctuation">(</span>tf<span class="token punctuation">.</span>float32<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token boolean">None</span><span class="token punctuation">,</span> TIME_STEP<span class="token punctuation">,</span> INPUT_SIZE<span class="token punctuation">]</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><blockquote><p>RNN</p></blockquote><div class="language-python line-numbers-mode"><pre class="language-python"><code>rnn_cell <span class="token operator">=</span> tf<span class="token punctuation">.</span>nn<span class="token punctuation">.</span>rnn_cell<span class="token punctuation">.</span>LSTMCell<span class="token punctuation">(</span>num_units<span class="token operator">=</span>CELL_SIZE<span class="token punctuation">)</span>
<span class="token comment"># very first hidden state</span>
init_s <span class="token operator">=</span> rnn_cell<span class="token punctuation">.</span>zero_state<span class="token punctuation">(</span>batch_size<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span> dtype<span class="token operator">=</span>tf<span class="token punctuation">.</span>float32<span class="token punctuation">)</span>
outputs<span class="token punctuation">,</span> final_s <span class="token operator">=</span> tf<span class="token punctuation">.</span>nn<span class="token punctuation">.</span>dynamic_rnn<span class="token punctuation">(</span>
    rnn_cell<span class="token punctuation">,</span>                   <span class="token comment"># cell you have chosen</span>
    tf_x<span class="token punctuation">,</span>                       <span class="token comment"># input</span>
    initial_state<span class="token operator">=</span>init_s<span class="token punctuation">,</span>       <span class="token comment"># the initial hidden state</span>
   
    <span class="token comment"># False: (batch, time step, input)</span>
    <span class="token comment"># True:  (time step, batch, input)</span>
    time_major<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">,</span>
<span class="token punctuation">)</span>
<span class="token comment"># reshape 3D output to 2D (flattened) for fully connected layer</span>
outs2D <span class="token operator">=</span> tf<span class="token punctuation">.</span>reshape<span class="token punctuation">(</span>outputs<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> CELL_SIZE<span class="token punctuation">]</span><span class="token punctuation">)</span>
net_outs2D <span class="token operator">=</span> tf<span class="token punctuation">.</span>layers<span class="token punctuation">.</span>dense<span class="token punctuation">(</span>outs2D<span class="token punctuation">,</span> INPUT_SIZE<span class="token punctuation">)</span>
<span class="token comment"># reshape back to 3D</span>
outs <span class="token operator">=</span> tf<span class="token punctuation">.</span>reshape<span class="token punctuation">(</span>net_outs2D<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> TIME_STEP<span class="token punctuation">,</span> INPUT_SIZE<span class="token punctuation">]</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br></div></div><blockquote><p>Loss / Training Ops</p></blockquote><div class="language-python line-numbers-mode"><pre class="language-python"><code>loss <span class="token operator">=</span> tf<span class="token punctuation">.</span>losses<span class="token punctuation">.</span>mean_squared_error<span class="token punctuation">(</span>labels<span class="token operator">=</span>tf_y<span class="token punctuation">,</span> predictions<span class="token operator">=</span>outs<span class="token punctuation">)</span>
train_op <span class="token operator">=</span> tf<span class="token punctuation">.</span>train<span class="token punctuation">.</span>AdamOptimizer<span class="token punctuation">(</span>LR<span class="token punctuation">)</span><span class="token punctuation">.</span>minimize<span class="token punctuation">(</span>loss<span class="token punctuation">)</span>
</code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><blockquote><p>Training</p></blockquote><div class="language-python line-numbers-mode"><pre class="language-python"><code>sess <span class="token operator">=</span> tf<span class="token punctuation">.</span>Session<span class="token punctuation">(</span><span class="token punctuation">)</span>
sess<span class="token punctuation">.</span>run<span class="token punctuation">(</span>tf<span class="token punctuation">.</span>global_variables_initializer<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token keyword">for</span> step <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">160</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    start<span class="token punctuation">,</span> end <span class="token operator">=</span> step <span class="token operator">*</span> np<span class="token punctuation">.</span>pi<span class="token punctuation">,</span> <span class="token punctuation">(</span>step<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token operator">*</span>np<span class="token punctuation">.</span>pi   <span class="token comment"># time range</span>
    <span class="token comment"># use sin predicts cos</span>
    steps <span class="token operator">=</span> np<span class="token punctuation">.</span>linspace<span class="token punctuation">(</span>start<span class="token punctuation">,</span> end<span class="token punctuation">,</span> TIME_STEP<span class="token punctuation">)</span>
    <span class="token comment"># shape (batch, time_step, input_size)</span>
    x <span class="token operator">=</span> np<span class="token punctuation">.</span>sin<span class="token punctuation">(</span>steps<span class="token punctuation">)</span><span class="token punctuation">[</span>np<span class="token punctuation">.</span>newaxis<span class="token punctuation">,</span> <span class="token punctuation">:</span><span class="token punctuation">,</span> np<span class="token punctuation">.</span>newaxis<span class="token punctuation">]</span>
    y <span class="token operator">=</span> np<span class="token punctuation">.</span>cos<span class="token punctuation">(</span>steps<span class="token punctuation">)</span><span class="token punctuation">[</span>np<span class="token punctuation">.</span>newaxis<span class="token punctuation">,</span> <span class="token punctuation">:</span><span class="token punctuation">,</span> np<span class="token punctuation">.</span>newaxis<span class="token punctuation">]</span>
    
    <span class="token keyword">if</span> <span class="token string">'final_s_'</span> <span class="token operator">not</span> <span class="token keyword">in</span> <span class="token builtin">globals</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token comment"># first state, no any hidden state</span>
        feed_dict <span class="token operator">=</span> <span class="token punctuation">{</span>tf_x<span class="token punctuation">:</span> x<span class="token punctuation">,</span> tf_y<span class="token punctuation">:</span> y<span class="token punctuation">}</span>
    <span class="token keyword">else</span><span class="token punctuation">:</span>                           <span class="token comment"># has hidden state, so pass it to rnn</span>
        feed_dict <span class="token operator">=</span> <span class="token punctuation">{</span>tf_x<span class="token punctuation">:</span> x<span class="token punctuation">,</span> tf_y<span class="token punctuation">:</span> y<span class="token punctuation">,</span> init_s<span class="token punctuation">:</span> final_s_<span class="token punctuation">}</span>
    
    _<span class="token punctuation">,</span> pred_<span class="token punctuation">,</span> final_s_ <span class="token operator">=</span> sess<span class="token punctuation">.</span>run<span class="token punctuation">(</span>
        <span class="token punctuation">[</span>train_op<span class="token punctuation">,</span> outs<span class="token punctuation">,</span> final_s<span class="token punctuation">]</span><span class="token punctuation">,</span> feed_dict<span class="token punctuation">)</span>     <span class="token comment"># train</span>

    <span class="token comment"># plotting</span>
    plt<span class="token punctuation">.</span>plot<span class="token punctuation">(</span>steps<span class="token punctuation">,</span> y<span class="token punctuation">.</span>flatten<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">'r-'</span><span class="token punctuation">)</span>
    plt<span class="token punctuation">.</span>plot<span class="token punctuation">(</span>steps<span class="token punctuation">,</span> pred_<span class="token punctuation">.</span>flatten<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">'b-'</span><span class="token punctuation">)</span>
    plt<span class="token punctuation">.</span>ylim<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1.2</span><span class="token punctuation">,</span> <span class="token number">1.2</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    plt<span class="token punctuation">.</span>draw<span class="token punctuation">(</span><span class="token punctuation">)</span>
    plt<span class="token punctuation">.</span>pause<span class="token punctuation">(</span><span class="token number">0.05</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br></div></div><h2 id="autoencoder-mnist"><a href="#autoencoder-mnist" aria-hidden="true" class="header-anchor">#</a> AutoEncoder (MNIST)</h2><blockquote><p>Setup (skip, same as CNN)</p></blockquote><blockquote><p>Prepare Input</p></blockquote><div class="language-python line-numbers-mode"><pre class="language-python"><code>BATCH_SIZE <span class="token operator">=</span> <span class="token number">64</span>
LR <span class="token operator">=</span> <span class="token number">0.002</span>  <span class="token comment"># learning rate</span>
N_TEST_IMG <span class="token operator">=</span> <span class="token number">5</span>

<span class="token comment"># use not one-hotted target data</span>
mnist <span class="token operator">=</span> input_data<span class="token punctuation">.</span>read_data_sets<span class="token punctuation">(</span><span class="token string">'./mnist'</span><span class="token punctuation">,</span> one_hot<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span>
test_x <span class="token operator">=</span> mnist<span class="token punctuation">.</span>test<span class="token punctuation">.</span>images<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token number">200</span><span class="token punctuation">]</span>
test_y <span class="token operator">=</span> mnist<span class="token punctuation">.</span>test<span class="token punctuation">.</span>labels<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token number">200</span><span class="token punctuation">]</span>

tf_x <span class="token operator">=</span> tf<span class="token punctuation">.</span>placeholder<span class="token punctuation">(</span>tf<span class="token punctuation">.</span>float32<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token boolean">None</span><span class="token punctuation">,</span> <span class="token number">28</span><span class="token operator">*</span><span class="token number">28</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><blockquote><p>Encoder</p></blockquote><div class="language-python line-numbers-mode"><pre class="language-python"><code>en0 <span class="token operator">=</span> tf<span class="token punctuation">.</span>layers<span class="token punctuation">.</span>dense<span class="token punctuation">(</span>tf_x<span class="token punctuation">,</span> <span class="token number">128</span><span class="token punctuation">,</span> tf<span class="token punctuation">.</span>nn<span class="token punctuation">.</span>tanh<span class="token punctuation">)</span>
en1 <span class="token operator">=</span> tf<span class="token punctuation">.</span>layers<span class="token punctuation">.</span>dense<span class="token punctuation">(</span>en0<span class="token punctuation">,</span> <span class="token number">64</span><span class="token punctuation">,</span> tf<span class="token punctuation">.</span>nn<span class="token punctuation">.</span>tanh<span class="token punctuation">)</span>
en2 <span class="token operator">=</span> tf<span class="token punctuation">.</span>layers<span class="token punctuation">.</span>dense<span class="token punctuation">(</span>en1<span class="token punctuation">,</span> <span class="token number">12</span><span class="token punctuation">,</span> tf<span class="token punctuation">.</span>nn<span class="token punctuation">.</span>tanh<span class="token punctuation">)</span>
encoded <span class="token operator">=</span> tf<span class="token punctuation">.</span>layers<span class="token punctuation">.</span>dense<span class="token punctuation">(</span>en2<span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><blockquote><p>Decoder</p></blockquote><div class="language-python line-numbers-mode"><pre class="language-python"><code>de0 <span class="token operator">=</span> tf<span class="token punctuation">.</span>layers<span class="token punctuation">.</span>dense<span class="token punctuation">(</span>encoded<span class="token punctuation">,</span> <span class="token number">12</span><span class="token punctuation">,</span> tf<span class="token punctuation">.</span>nn<span class="token punctuation">.</span>tanh<span class="token punctuation">)</span>
de1 <span class="token operator">=</span> tf<span class="token punctuation">.</span>layers<span class="token punctuation">.</span>dense<span class="token punctuation">(</span>de0<span class="token punctuation">,</span> <span class="token number">64</span><span class="token punctuation">,</span> tf<span class="token punctuation">.</span>nn<span class="token punctuation">.</span>tanh<span class="token punctuation">)</span>
de2 <span class="token operator">=</span> tf<span class="token punctuation">.</span>layers<span class="token punctuation">.</span>dense<span class="token punctuation">(</span>de1<span class="token punctuation">,</span> <span class="token number">128</span><span class="token punctuation">,</span> tf<span class="token punctuation">.</span>nn<span class="token punctuation">.</span>tanh<span class="token punctuation">)</span>
decoded <span class="token operator">=</span> tf<span class="token punctuation">.</span>layers<span class="token punctuation">.</span>dense<span class="token punctuation">(</span>de2<span class="token punctuation">,</span> <span class="token number">28</span><span class="token operator">*</span><span class="token number">28</span><span class="token punctuation">,</span> tf<span class="token punctuation">.</span>nn<span class="token punctuation">.</span>sigmoid<span class="token punctuation">)</span>
</code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><blockquote><p>Loss / Training Ops</p></blockquote><div class="language-python line-numbers-mode"><pre class="language-python"><code>loss <span class="token operator">=</span> tf<span class="token punctuation">.</span>losses<span class="token punctuation">.</span>mean_squared_error<span class="token punctuation">(</span>labels<span class="token operator">=</span>tf_x<span class="token punctuation">,</span> predictions<span class="token operator">=</span>decoded<span class="token punctuation">)</span>
train <span class="token operator">=</span> tf<span class="token punctuation">.</span>train<span class="token punctuation">.</span>AdamOptimizer<span class="token punctuation">(</span>LR<span class="token punctuation">)</span><span class="token punctuation">.</span>minimize<span class="token punctuation">(</span>loss<span class="token punctuation">)</span>
</code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><blockquote><p>Setup subplots for visualizing training progress</p></blockquote><div class="language-python line-numbers-mode"><pre class="language-python"><code>f<span class="token punctuation">,</span> a <span class="token operator">=</span> plt<span class="token punctuation">.</span>subplots<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> N_TEST_IMG<span class="token punctuation">,</span> figsize<span class="token operator">=</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
plt<span class="token punctuation">.</span>ion<span class="token punctuation">(</span><span class="token punctuation">)</span>   <span class="token comment"># continuous plotting</span>

<span class="token comment"># Plot first N test images during trainig</span>
test_data <span class="token operator">=</span> mnist<span class="token punctuation">.</span>test<span class="token punctuation">.</span>images<span class="token punctuation">[</span><span class="token punctuation">:</span>N_TEST_IMG<span class="token punctuation">]</span>
<span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span>N_TEST_IMG<span class="token punctuation">)</span><span class="token punctuation">:</span>
    a<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>imshow<span class="token punctuation">(</span>np<span class="token punctuation">.</span>reshape<span class="token punctuation">(</span>test_data<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">28</span><span class="token punctuation">,</span> <span class="token number">28</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> cmap<span class="token operator">=</span><span class="token string">'gray'</span><span class="token punctuation">)</span>
    a<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>set_xticks<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    a<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>set_yticks<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><blockquote><p>Training</p></blockquote><div class="language-python line-numbers-mode"><pre class="language-python"><code>sess <span class="token operator">=</span> tf<span class="token punctuation">.</span>Session<span class="token punctuation">(</span><span class="token punctuation">)</span>
sess<span class="token punctuation">.</span>run<span class="token punctuation">(</span>tf<span class="token punctuation">.</span>global_variables_initializer<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token keyword">for</span> step <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">8000</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    b_x<span class="token punctuation">,</span> b_y <span class="token operator">=</span> mnist<span class="token punctuation">.</span>train<span class="token punctuation">.</span>next_batch<span class="token punctuation">(</span>BATCH_SIZE<span class="token punctuation">)</span>
    _<span class="token punctuation">,</span> encoded_<span class="token punctuation">,</span> decoded_<span class="token punctuation">,</span> loss_ <span class="token operator">=</span> sess<span class="token punctuation">.</span>run<span class="token punctuation">(</span>
        <span class="token punctuation">[</span>train<span class="token punctuation">,</span> encoded<span class="token punctuation">,</span> decoded<span class="token punctuation">,</span> loss<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>tf_x<span class="token punctuation">:</span> b_x<span class="token punctuation">}</span><span class="token punctuation">)</span>

    <span class="token keyword">if</span> step <span class="token operator">%</span> <span class="token number">100</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">:</span> <span class="token comment"># plotting</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'train loss: %.4f'</span> <span class="token operator">%</span> loss_<span class="token punctuation">)</span>
        <span class="token comment"># plotting decoded image (second row)</span>
        decoded_data <span class="token operator">=</span> sess<span class="token punctuation">.</span>run<span class="token punctuation">(</span>decoded<span class="token punctuation">,</span> <span class="token punctuation">{</span>tf_x<span class="token punctuation">:</span> test_data<span class="token punctuation">}</span><span class="token punctuation">)</span>
        <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span>N_TEST_IMG<span class="token punctuation">)</span><span class="token punctuation">:</span>
            a<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>clear<span class="token punctuation">(</span><span class="token punctuation">)</span>
            a<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>imshow<span class="token punctuation">(</span>np<span class="token punctuation">.</span>reshape<span class="token punctuation">(</span>decoded_data<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">28</span><span class="token punctuation">,</span> <span class="token number">28</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> cmap<span class="token operator">=</span><span class="token string">'gray'</span><span class="token punctuation">)</span>
            a<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>set_xticks<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            a<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>set_yticks<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        plt<span class="token punctuation">.</span>draw<span class="token punctuation">(</span><span class="token punctuation">)</span>
        plt<span class="token punctuation">.</span>pause<span class="token punctuation">(</span><span class="token number">0.01</span><span class="token punctuation">)</span>
plt<span class="token punctuation">.</span>ioff<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br></div></div><p><img src="/images/autoencoder-train-visualize.png" alt="autoencoder-train-visualize.png"></p><p><em><div class="caption"> First row is the original test images, second row is 'decoded' test images. </div></em></p><blockquote><p>Test data 3D visualization</p></blockquote><div class="language-python line-numbers-mode"><pre class="language-python"><code><span class="token keyword">from</span> mpl_toolkits<span class="token punctuation">.</span>mplot3d <span class="token keyword">import</span> Axes3D
<span class="token keyword">from</span> matplotlib <span class="token keyword">import</span> cm

fig <span class="token operator">=</span> plt<span class="token punctuation">.</span>figure<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span>
ax <span class="token operator">=</span> Axes3D<span class="token punctuation">(</span>fig<span class="token punctuation">)</span>
X<span class="token punctuation">,</span> Y<span class="token punctuation">,</span> Z <span class="token operator">=</span> encoded_data<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> encoded_data<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> encoded_data<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">]</span>

test_data <span class="token operator">=</span> test_x<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token number">200</span><span class="token punctuation">]</span>
encoded_data <span class="token operator">=</span> sess<span class="token punctuation">.</span>run<span class="token punctuation">(</span>encoded<span class="token punctuation">,</span> <span class="token punctuation">{</span>tf_x<span class="token punctuation">:</span> test_data<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token keyword">for</span> x<span class="token punctuation">,</span> y<span class="token punctuation">,</span> z<span class="token punctuation">,</span> s <span class="token keyword">in</span> <span class="token builtin">zip</span><span class="token punctuation">(</span>X<span class="token punctuation">,</span> Y<span class="token punctuation">,</span> Z<span class="token punctuation">,</span> test_y<span class="token punctuation">)</span><span class="token punctuation">:</span>
    c <span class="token operator">=</span> cm<span class="token punctuation">.</span>rainbow<span class="token punctuation">(</span><span class="token builtin">int</span><span class="token punctuation">(</span><span class="token number">255</span><span class="token operator">*</span>s<span class="token operator">/</span><span class="token number">9</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    ax<span class="token punctuation">.</span>text<span class="token punctuation">(</span>x<span class="token punctuation">,</span> y<span class="token punctuation">,</span> z<span class="token punctuation">,</span> s<span class="token punctuation">,</span> backgroundcolor<span class="token operator">=</span>c<span class="token punctuation">)</span>
    
ax<span class="token punctuation">.</span>set_xlim<span class="token punctuation">(</span>X<span class="token punctuation">.</span><span class="token builtin">min</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> X<span class="token punctuation">.</span><span class="token builtin">max</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
ax<span class="token punctuation">.</span>set_ylim<span class="token punctuation">(</span>Y<span class="token punctuation">.</span><span class="token builtin">min</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> Y<span class="token punctuation">.</span><span class="token builtin">max</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
ax<span class="token punctuation">.</span>set_zlim<span class="token punctuation">(</span>Z<span class="token punctuation">.</span><span class="token builtin">min</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> Z<span class="token punctuation">.</span><span class="token builtin">max</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
plt<span class="token punctuation">.</span>show<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br></div></div><p><img src="/images/autoencoder-3d-visualize.png" alt="autoencoder-3d-visualize.png"></p><p><em><div class="caption"> Visualize relationships between digits that encoder has learned. Use t-SNE for dimension reduction. </div></em></p></div><div class="page-edit"><!----><!----></div><div class="page-nav"><p class="inner"><!----><span class="next"><a href="/dev_notes/ml/tensorflow/syntax.html">
          Tensorflow Syntax
        </a> →
      </span></p></div></div></div></div>
    <script src="/assets/js/8.42ea1d9b.js" defer></script><script src="/assets/js/app.e04e06c7.js" defer></script>
  </body>
</html>
